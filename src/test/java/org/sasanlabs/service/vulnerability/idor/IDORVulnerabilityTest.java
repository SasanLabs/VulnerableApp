package org.sasanlabs.service.vulnerability.idor;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

class IDORVulnerabilityTest {

    private IDORVulnerability idorVulnerability;

    @BeforeEach
    void setUp() {
        idorVulnerability = new IDORVulnerability();
    }

    @Test
    void testLevel1_NoAuth_AllowsAccess() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel1("101");

        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertNotNull(response.getBody());
        assertEquals(true, response.getBody().getIsValid());
    }

    @Test
    void testLevel2_NoOwnershipCheck_AllowsOtherUserAccess() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel2("102", "101");

        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertNotNull(response.getBody());
        assertEquals(true, response.getBody().getIsValid());
    }

    @Test
    void testLevel5_Secure_DeniesUnauthorizedAccess() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel5("102", "101");

        assertEquals(HttpStatus.OK, response.getStatusCode());
    }

    @Test
    void testLevel3_RoleTampering() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel3("102", "101", "ADMIN");

        assertEquals(true, response.getBody().getIsValid());
    }

    @Test
    void testLevel4_UUIDIllusion() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel4("ACC-102-ABC", "101");

        assertEquals(true, response.getBody().getIsValid());
    }

    @Test
    void testLevel5_Secure_AllowsAuthorizedAccess() {
        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idorVulnerability.idorLevel5("101", "101");

        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertNotNull(response.getBody());
        assertEquals(true, response.getBody().getIsValid());
    }
}
