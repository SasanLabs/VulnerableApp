package org.sasanlabs.service.vulnerability.idor;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.util.Arrays;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.JdbcTemplate;

class IDORVulnerabilityTest {

    private IDORVulnerability idor;
    private JdbcTemplate jdbcTemplate;

    @BeforeEach
    void setup() {
        jdbcTemplate = mock(JdbcTemplate.class);
        idor = new IDORVulnerability(jdbcTemplate);
    }

    // ---------------- LEVEL 1 ----------------

    @Test
    void level1_Login_ShouldSucceed() {

        HttpSession session = mock(HttpSession.class);

        when(jdbcTemplate.query(
                        anyString(),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList(1));

        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idor.level1("alice", "password", null, session);

        assertTrue(response.getBody().getIsValid());
    }

    @Test
    void level1_ShouldAllowAccessToAnyId() {

        HttpSession session = mock(HttpSession.class);

        when(jdbcTemplate.query(
                        anyString(),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList("User: Bob | Salary: ₹60000"));

        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idor.level1(null, null, 2, session);

        assertTrue(response.getBody().getIsValid());
    }

    // ---------------- LEVEL 2 ----------------

    @Test
    void level2_ShouldAllowCookieTampering() {

        HttpServletResponse response = mock(HttpServletResponse.class);

        when(jdbcTemplate.query(
                        anyString(),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList("User: Bob | Salary: ₹60000"));

        // loggedInUser cookie says 1
        // but we request id = 2
        ResponseEntity<GenericVulnerabilityResponseBean<String>> result =
                idor.level2(null, null, 2, response, 1);

        assertTrue(result.getBody().getIsValid());
    }

    // ---------------- LEVEL 3 ----------------

    @Test
    void level3_ShouldAllowUserIdTampering() {

        String fakeToken =
                java.util.Base64.getEncoder()
                        .encodeToString("{\"userId\":2,\"role\":\"USER\"}".getBytes());

        when(jdbcTemplate.query(
                        anyString(),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList("User: Bob | Salary: ₹60000"));

        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idor.level3(null, null, fakeToken);

        assertTrue(response.getBody().getIsValid());
    }

    // ---------------- LEVEL 4 ----------------

    @Test
    void level4_ShouldAllowRoleEscalation() {

        String escalatedToken =
                java.util.Base64.getEncoder()
                        .encodeToString("{\"userId\":1,\"role\":\"ADMIN\"}".getBytes());

        when(jdbcTemplate.query(
                        anyString(),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList("User: Bob | Salary: ₹60000"));

        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idor.level4(null, null, escalatedToken, 2);

        assertTrue(response.getBody().getIsValid());
    }

    // ---------------- LEVEL 5 ----------------

    @Test
    void level5_ShouldBlockRoleEscalation() {

        String escalatedToken =
                java.util.Base64.getEncoder()
                        .encodeToString("{\"userId\":1,\"role\":\"ADMIN\"}".getBytes());

        // DB says userId 1 is USER
        when(jdbcTemplate.query(
                        eq("SELECT role FROM idor_users WHERE id=?"),
                        any(Object[].class),
                        any(org.springframework.jdbc.core.RowMapper.class)))
                .thenReturn(Arrays.asList("USER"));

        ResponseEntity<GenericVulnerabilityResponseBean<String>> response =
                idor.level5(null, null, escalatedToken, 2);

        assertFalse(response.getBody().getIsValid());
    }
}
