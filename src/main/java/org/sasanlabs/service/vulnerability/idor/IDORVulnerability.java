package org.sasanlabs.service.vulnerability.idor;

import java.util.HashMap;
import java.util.Map;
import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.Variant;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestParam;

@VulnerableAppRestController(descriptionLabel = "IDOR_VULNERABILITY", value = "IDORVulnerability")
public class IDORVulnerability {

    private static final String USER_ID = "userId";

    private static final Map<String, String> userData = new HashMap<>();

    static {
        userData.put("101", "User 101 - Account Balance: ₹5000");
        userData.put("102", "User 102 - Account Balance: ₹15000");
        userData.put("103", "User 103 - Account Balance: ₹25000");
    }

    private ResponseEntity<GenericVulnerabilityResponseBean<String>> getResponse(String userId) {
        String data = userData.getOrDefault(userId, "User not found");
        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>(data, true), HttpStatus.OK);
    }

    // LEVEL 1 - Direct access without any check
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_1_NO_AUTH_CHECK",
            payload = "Try changing userId parameter to access other users")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_1, htmlTemplate = "LEVEL_1/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> idorLevel1(
            @RequestParam(USER_ID) String userId) {

        // No authentication or authorization
        return getResponse(userId);
    }

    // LEVEL 2 - Fake logged in user but no ownership validation
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_2_FAKE_LOGIN_NO_AUTHZ",
            payload = "Logged in user is 101 but try accessing 102")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_2, htmlTemplate = "LEVEL_2/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> idorLevel2(
            @RequestParam(USER_ID) String userId,
            @RequestParam("loggedInUser") String loggedInUser) {

        // Still no ownership check
        return getResponse(userId);
    }

    // LEVEL 3 - Secure version (Proper Fix)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_3_SECURE",
            payload = "Access only allowed to your own account")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_3,
            htmlTemplate = "LEVEL_3/IDOR",
            variant = Variant.SECURE)
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> idorLevel3(
            @RequestParam(USER_ID) String userId,
            @RequestParam("loggedInUser") String loggedInUser) {

        if (!userId.equals(loggedInUser)) {
            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>(
                            "Access Denied - Unauthorized Access", false),
                    HttpStatus.OK);
        }

        return getResponse(userId);
    }
}
