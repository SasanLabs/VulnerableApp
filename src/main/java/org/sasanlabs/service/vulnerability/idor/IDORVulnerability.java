package org.sasanlabs.service.vulnerability.idor;

import java.util.Base64;
import java.util.List;
import javax.servlet.http.HttpSession;
import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.Variant;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.RequestParam;

@VulnerableAppRestController(descriptionLabel = "IDOR_VULNERABILITY", value = "IDORVulnerability")
public class IDORVulnerability {

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    public IDORVulnerability(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    // LEVEL 1: No Authorization Check (IDOR)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_1_NO_AUTHORIZATION",
            payload = "IDOR_PAYLOAD_LEVEL_1")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_1, htmlTemplate = "LEVEL_1/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> level1(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String password,
            @RequestParam(required = false) Integer id,
            HttpSession session) {

        // LOGIN FLOW
        if (username != null && password != null) {

            String sql = "SELECT id FROM idor_users WHERE username=? AND password=?";

            List<Integer> result =
                    jdbcTemplate.query(
                            sql,
                            new Object[] {username, password},
                            (rs, rowNum) -> rs.getInt("id"));

            if (result.isEmpty()) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("Invalid credentials", false),
                        HttpStatus.OK);
            }

            session.setAttribute("userId", result.get(0));

            String loggedInUser = "Logged in as: " + username + " (id=" + result.get(0) + ")";

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>(loggedInUser, true), HttpStatus.OK);
        }

        // PROFILE ACCESS FLOW (VULNERABLE)
        if (id != null) {

            String sql = "SELECT username, salary FROM idor_users WHERE id=?";

            List<String> result =
                    jdbcTemplate.query(
                            sql,
                            new Object[] {id},
                            (rs, rowNum) ->
                                    "User: "
                                            + rs.getString("username")
                                            + " | Salary: ₹"
                                            + rs.getInt("salary"));

            if (result.isEmpty()) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("User not found", false),
                        HttpStatus.OK);
            }

            // NO OWNERSHIP CHECK → IDOR
            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>(result.get(0), true), HttpStatus.OK);
        }

        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>("Please login first", false), HttpStatus.OK);
    }

    // LEVEL 2: Cookie Tampering (IDOR)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_2_COOKIE_TAMPERING",
            payload = "IDOR_PAYLOAD_LEVEL_2")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_2, htmlTemplate = "LEVEL_2/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> level2(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String password,
            @RequestParam(required = false) Integer id,
            javax.servlet.http.HttpServletResponse response,
            @org.springframework.web.bind.annotation.CookieValue(value = "userId", required = false)
                    Integer loggedInUser) {

        // LOGIN FLOW
        if (username != null && password != null) {

            String sql = "SELECT id FROM idor_users WHERE username=? AND password=?";

            List<Integer> result =
                    jdbcTemplate.query(
                            sql,
                            new Object[] {username, password},
                            (rs, rowNum) -> rs.getInt("id"));

            if (result.isEmpty()) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("Invalid credentials", false),
                        HttpStatus.OK);
            }

            Integer userId = result.get(0);

            // Vulnerable: store authentication in cookie
            javax.servlet.http.Cookie cookie =
                    new javax.servlet.http.Cookie("userId", String.valueOf(userId));
            response.addCookie(cookie);

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>(
                            "Login successful. Cookie userId=" + userId + " set.", true),
                    HttpStatus.OK);
        }

        // PROFILE ACCESS FLOW
        if (loggedInUser != null) {

            String sql = "SELECT username, salary FROM idor_users WHERE id=?";

            List<String> result =
                    jdbcTemplate.query(
                            sql,
                            new Object[] {loggedInUser},
                            (rs, rowNum) ->
                                    "User: "
                                            + rs.getString("username")
                                            + " | Salary: ₹"
                                            + rs.getInt("salary"));

            if (result.isEmpty()) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("User not found", false),
                        HttpStatus.OK);
            }

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>(result.get(0), true), HttpStatus.OK);
        }

        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>("Please login first.", false),
                HttpStatus.OK);
    }

    // LEVEL 3: JWT Tampering (IDOR)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_3_JWT_TAMPERING",
            payload = "IDOR_PAYLOAD_LEVEL_3")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_3, htmlTemplate = "LEVEL_3/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> level3(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String password,
            @RequestParam(required = false) String token) {

        try {

            // LOGIN FLOW
            if (username != null && password != null) {

                String sql = "SELECT id, role FROM idor_users WHERE username=? AND password=?";

                List<String> result =
                        jdbcTemplate.query(
                                sql,
                                new Object[] {username, password},
                                (rs, rowNum) ->
                                        "{\"userId\":"
                                                + rs.getInt("id")
                                                + ",\"role\":\""
                                                + rs.getString("role")
                                                + "\"}");

                if (result.isEmpty()) {
                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>("Invalid credentials", false),
                            HttpStatus.OK);
                }

                String generatedToken =
                        java.util.Base64.getEncoder().encodeToString(result.get(0).getBytes());

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("Token: " + generatedToken, true),
                        HttpStatus.OK);
            }

            // PROFILE ACCESS FLOW
            if (token != null) {

                String decoded = new String(java.util.Base64.getDecoder().decode(token));

                int userId = Integer.parseInt(decoded.split("userId\":")[1].split(",")[0]);

                String role = decoded.split("role\":\"")[1].split("\"")[0];

                String sql = "SELECT username, salary FROM idor_users WHERE id=?";

                List<String> result =
                        jdbcTemplate.query(
                                sql,
                                new Object[] {userId},
                                (rs, rowNum) ->
                                        "User: "
                                                + rs.getString("username")
                                                + " | Salary: ₹"
                                                + rs.getInt("salary")
                                                + " | Role: "
                                                + role);

                if (result.isEmpty()) {
                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>("User not found", false),
                            HttpStatus.OK);
                }

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(result.get(0), true), HttpStatus.OK);
            }

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Provide login or token", false),
                    HttpStatus.OK);

        } catch (Exception e) {
            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Invalid token", false), HttpStatus.OK);
        }
    }

    // LEVEL 4: Broken RBAC (IDOR)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_4_BROKEN_RBAC",
            payload = "IDOR_PAYLOAD_LEVEL_4")
    @VulnerableAppRequestMapping(value = LevelConstants.LEVEL_4, htmlTemplate = "LEVEL_4/IDOR")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> level4(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String password,
            @RequestParam(required = false) String token,
            @RequestParam(required = false) Integer id) {

        try {

            // LOGIN FLOW (same as level 3)
            if (username != null && password != null) {

                String sql = "SELECT id, role FROM idor_users WHERE username=? AND password=?";

                List<String> result =
                        jdbcTemplate.query(
                                sql,
                                new Object[] {username, password},
                                (rs, rowNum) ->
                                        "{\"userId\":"
                                                + rs.getInt("id")
                                                + ",\"role\":\""
                                                + rs.getString("role")
                                                + "\"}");

                if (result.isEmpty()) {
                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>("Invalid credentials", false),
                            HttpStatus.OK);
                }

                String generatedToken =
                        Base64.getEncoder().encodeToString(result.get(0).getBytes());

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("Token: " + generatedToken, true),
                        HttpStatus.OK);
            }

            // PROFILE ACCESS FLOW
            if (token != null && id != null) {

                String decoded = new String(Base64.getDecoder().decode(token));

                int tokenUserId = Integer.parseInt(decoded.split("userId\":")[1].split(",")[0]);
                String role = decoded.split("role\":\"")[1].split("\"")[0];

                // RBAC logic
                if ("ADMIN".equalsIgnoreCase(role) || tokenUserId == id) {

                    String sql = "SELECT username, salary FROM idor_users WHERE id=?";

                    List<String> result =
                            jdbcTemplate.query(
                                    sql,
                                    new Object[] {id},
                                    (rs, rowNum) ->
                                            "User: "
                                                    + rs.getString("username")
                                                    + " | Salary: ₹"
                                                    + rs.getInt("salary")
                                                    + " | Role: "
                                                    + role);

                    if (result.isEmpty()) {
                        return new ResponseEntity<>(
                                new GenericVulnerabilityResponseBean<>("User not found", false),
                                HttpStatus.OK);
                    }

                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>(result.get(0), true),
                            HttpStatus.OK);
                }

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(
                                "Access Denied - Insufficient privileges", false),
                        HttpStatus.OK);
            }

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Provide login or token", false),
                    HttpStatus.OK);

        } catch (Exception e) {
            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Invalid token", false), HttpStatus.OK);
        }
    }

    // LEVEL 5: Secure RBAC (IDOR)
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.INSECURE_DIRECT_OBJECT_REFERENCE,
            description = "IDOR_LEVEL_5_SECURE_RBAC",
            payload = "Server validates role from database and enforces proper authorization")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_5,
            htmlTemplate = "LEVEL_5/IDOR",
            variant = Variant.SECURE)
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> level5(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String password,
            @RequestParam(required = false) String token,
            @RequestParam(required = false) Integer id) {

        try {

            // LOGIN FLOW
            if (username != null && password != null) {

                String sql = "SELECT id, role FROM idor_users WHERE username=? AND password=?";

                List<String> result =
                        jdbcTemplate.query(
                                sql,
                                new Object[] {username, password},
                                (rs, rowNum) ->
                                        "{\"userId\":"
                                                + rs.getInt("id")
                                                + ",\"role\":\""
                                                + rs.getString("role")
                                                + "\"}");

                if (result.isEmpty()) {
                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>("Invalid credentials", false),
                            HttpStatus.OK);
                }

                String generatedToken =
                        Base64.getEncoder().encodeToString(result.get(0).getBytes());

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>("Token: " + generatedToken, true),
                        HttpStatus.OK);
            }

            // PROFILE ACCESS FLOW
            if (token != null && id != null) {

                String decoded = new String(Base64.getDecoder().decode(token));
                int tokenUserId = Integer.parseInt(decoded.split("userId\":")[1].split(",")[0]);

                // IMPORTANT: Fetch actual role from DB
                String roleSql = "SELECT role FROM idor_users WHERE id=?";
                List<String> roles =
                        jdbcTemplate.query(
                                roleSql,
                                new Object[] {tokenUserId},
                                (rs, rowNum) -> rs.getString("role"));

                if (roles.isEmpty()) {
                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>("Invalid user", false),
                            HttpStatus.OK);
                }

                String actualRole = roles.get(0);

                // Proper authorization
                if ("ADMIN".equalsIgnoreCase(actualRole) || tokenUserId == id) {

                    String sql = "SELECT username, salary, role FROM idor_users WHERE id=?";

                    List<String> result =
                            jdbcTemplate.query(
                                    sql,
                                    new Object[] {id},
                                    (rs, rowNum) ->
                                            "User: "
                                                    + rs.getString("username")
                                                    + " | Salary: ₹"
                                                    + rs.getInt("salary")
                                                    + " | Role: "
                                                    + rs.getString("role"));

                    return new ResponseEntity<>(
                            new GenericVulnerabilityResponseBean<>(result.get(0), true),
                            HttpStatus.OK);
                }

                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(
                                "Access Denied - Proper RBAC enforced", false),
                        HttpStatus.OK);
            }

            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Provide login or token", false),
                    HttpStatus.OK);

        } catch (Exception e) {
            return new ResponseEntity<>(
                    new GenericVulnerabilityResponseBean<>("Invalid token", false), HttpStatus.OK);
        }
    }
}
