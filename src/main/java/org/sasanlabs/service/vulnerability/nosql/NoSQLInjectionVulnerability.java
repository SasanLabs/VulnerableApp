package org.sasanlabs.service.vulnerability.nosql;

import java.util.List;
import java.util.Map;
import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.Variant;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.BasicQuery;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestParam;

@VulnerableAppRestController(
        descriptionLabel = "NOSQL_INJECTION_VULNERABILITY",
        value = "NoSQLInjectionVulnerability")
public class NoSQLInjectionVulnerability {

    private final MongoTemplate mongoTemplate;

    @Autowired
    public NoSQLInjectionVulnerability(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }

    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.NOSQL_INJECTION,
            description = "NOSQL_INJECTION_VULNERABILITY")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_1,
            htmlTemplate = "LEVEL_1/NoSQLInjection_Level1")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel1(
            @RequestParam Map<String, String> queryParams) {
        String username = queryParams.get("username");
        if (username != null) {
            // Allow user to break out of the string context
            String queryStr = "{ \"username\": \"" + username + "\" }";
            try {
                BasicQuery query = new BasicQuery(queryStr);
                List<User> users = mongoTemplate.find(query, User.class);
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(users.toString(), true),
                        HttpStatus.OK);
            } catch (Exception e) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(
                                "Error executing query: " + e.getMessage(), false),
                        HttpStatus.OK);
            }
        }
        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>("Please provide a username", false),
                HttpStatus.OK);
    }

    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.NOSQL_INJECTION,
            description = "NOSQL_INJECTION_VULNERABILITY")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_2,
            htmlTemplate = "LEVEL_1/NoSQLInjection_Level1",
            variant = Variant.SECURE)
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel2(
            @RequestParam Map<String, String> queryParams) {
        String username = queryParams.get("username");
        if (username != null) {
            try {
                Query query = new Query();
                query.addCriteria(Criteria.where("username").is(username));
                List<User> users = mongoTemplate.find(query, User.class);
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(users.toString(), true),
                        HttpStatus.OK);
            } catch (Exception e) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(
                                "Error executing query: " + e.getMessage(), false),
                        HttpStatus.OK);
            }
        }
        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>("Please provide a username", false),
                HttpStatus.OK);
    }
}
