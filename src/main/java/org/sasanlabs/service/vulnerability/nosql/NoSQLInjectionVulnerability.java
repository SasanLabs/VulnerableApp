package org.sasanlabs.service.vulnerability.nosql;

import java.util.List;
import java.util.Map;
import javax.annotation.PostConstruct;
import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;
import org.sasanlabs.service.vulnerability.bean.GenericVulnerabilityResponseBean;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.BasicQuery;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * @author KSASAN preetkaran20@gmail.com
 */
@VulnerableAppRestController(
        descriptionLabel = "NOSQL_INJECTION_VULNERABILITY",
        value = "NoSQLInjectionVulnerability")
public class NoSQLInjectionVulnerability {

    private final MongoTemplate mongoTemplate;

    @Autowired
    public NoSQLInjectionVulnerability(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }

    @PostConstruct
    public void init() {
        if (mongoTemplate.collectionExists(User.class)) {
            mongoTemplate.dropCollection(User.class);
        }
        mongoTemplate.save(new User("admin", "SecretPassword123", "Admin User"));
        mongoTemplate.save(new User("user1", "UserPassword456", "Normal User"));
        mongoTemplate.save(new User("guest", "guest", "Guest User"));
    }

    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.NOSQL_INJECTION,
            description = "NOSQL_INJECTION_VULNERABILITY")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_1,
            htmlTemplate = "LEVEL_1/NoSQLInjection_Level1")
    public ResponseEntity<GenericVulnerabilityResponseBean<String>> getVulnerablePayloadLevel1(
            @RequestParam Map<String, String> queryParams) {
        String username = queryParams.get("username");
        if (username != null) {
            // Vulnerable Query: String concatenation in BasicQuery
            // Attack payload example: ' || '1'=='1
            // Resulting query: { "username": '' || '1'=='1' } -> Evaluates to true for all docs (in
            // $where context)
            // Or simpler JSON injection if we were using a different parser, but BasicQuery takes a
            // JSON string.
            // Let's try to simulate a structure where we can inject properties.
            // Query: { "username": "<input>" }
            // Input: admin" , "password": { "$ne": "1" } }
            // Result: { "username": "admin" , "password": { "$ne": "1" } } }  <- Trailing brace
            // might be an issue or ignored

            // Allow user to break out of the string context
            String queryStr = "{ \"username\": \"" + username + "\" }";
            try {
                BasicQuery query = new BasicQuery(queryStr);
                List<User> users = mongoTemplate.find(query, User.class);
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(users.toString(), true),
                        HttpStatus.OK);
            } catch (Exception e) {
                return new ResponseEntity<>(
                        new GenericVulnerabilityResponseBean<>(
                                "Error executing query: " + e.getMessage(), false),
                        HttpStatus.OK);
            }
        }
        return new ResponseEntity<>(
                new GenericVulnerabilityResponseBean<>("Please provide a username", false),
                HttpStatus.OK);
    }

    public static class User {
        public String id;
        public String username;
        public String password;
        public String name;

        public User() {}

        public User(String username, String password, String name) {
            this.username = username;
            this.password = password;
            this.name = name;
        }

        @Override
        public String toString() {
            return "User{"
                    + "username='"
                    + username
                    + '\''
                    + ", name='"
                    + name
                    + '\''
                    + '}';
        }
    }
}
